<div class="px-1 full-width">
  <app-breadcrumbs></app-breadcrumbs>
  <div id="invoice-contents" *ngIf="request" class="px-2 card-header">
    <div *ngIf="!editMode" class="full-width row" [formGroup]="notesFormGroup">
      <div class="column w-30 pl-2">
        <h1 class="project-label no-top-margin">{{ project.name }}</h1>
        <h3 class="project-label">
          <span class="section-label">Request: </span>
          <span *ngIf="request.oneUp">{{ request.oneUp }}</span>
          <span *ngIf="!request.oneUp">NEW REQUEST</span>
        </h3>
        <div class="row pt-1 no-row-margins" style="max-height:75px">
          <div class="form-group">
            <mat-form-field *ngIf="canSubmitRequest && request.isDraft()">
              <input
                matInput
                autocomplete="off"
                formControlName="startDate"
                [matDatepicker]="startDatePicker"
                placeholder="Start Date"
                required
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="startDatePicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #startDatePicker></mat-datepicker>
            </mat-form-field>
            <div *ngIf="!canSubmitRequest || !request.isDraft()">
              {{ request.startDate | date: 'M/dd/yy' }}
            </div>
          </div>
          <div class="form-group">
            <mat-form-field
              *ngIf="canSubmitRequest && request.isDraft()"
              class="pl-2"
            >
              <input
                matInput
                formControlName="endDate"
                autocomplete="off"
                [matDatepicker]="endDatePicker"
                placeholder="End Date"
                required
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="endDatePicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #endDatePicker></mat-datepicker>
            </mat-form-field>
            <div *ngIf="!canSubmitRequest || !request.isDraft()" class="pl-2">
              {{ request.endDate | date: 'M/dd/yy' }}
            </div>
          </div>
        </div>

        <small class="warning-label" *ngIf="notesFormGroup.hasError('notValid')"
          >End Date must be after Start Date</small
        >
      </div>
      <div class="spacer"></div>
      <div *ngIf="request && project" class="column w-25 align-items-center">
        <h3 class="no-top-margin row-details pt-1">Notes</h3>

        <div class="full-width">
          <textarea
            *ngIf="canSubmitRequest && request.isDraft()"
            (change)="notesChanged()"
            class="full-width"
            id="request_notes"
            rows="3"
            formControlName="notes"
          ></textarea>
          <div *ngIf="!canSubmitRequest || !request.isDraft()">
            {{ request.notes }}
          </div>
        </div>
      </div>
      <div class="spacer"></div>
      <h3
        class="px-1 row strong no-top-margin warning-label"
        *ngIf="!request.isComplete()"
      >
        {{ request.status.toUpperCase() }}
      </h3>
      <h1
        class="px-1 row strong no-top-margin cost-label"
        *ngIf="request.isComplete()"
      >
        APPROVED
      </h1>
    </div>

    <div class="px-1">
      <div
        *ngIf="
          request &&
          request.status.toLowerCase() !== 'draft' &&
          (canManageRequest || canManageProject)
        "
        class="row mt-1"
      >
        <button
          type="button"
          *ngIf="request.status.toLowerCase() === 'pending'"
          (click)="approveRequest()"
          class="btn btn-primary"
          color="primary"
        >
          Approve Request
        </button>
      </div>
      <div
        *ngIf="
          request &&
          (request.status.toLowerCase() === 'new' ||
            request.status.toLowerCase() === 'draft')
        "
        class="row mt-1"
      >
        <button
          *ngIf="canSubmitRequest"
          [disabled]="
            signatureFormGroup.invalid ||
            notesFormGroup.hasError('notValid') ||
            !project ||
            !request.hasLineItems() ||
            !request.isDraft()
          "
          class="ripple
          btn
          btn-success mr-1"
          (click)="submitRequest()"
        >
          Submit Request
        </button>
        <button
          type="button"
          *ngIf="!request.id"
          class="btn
          btn-outline-danger ripple"
          matTooltip="Cancel Request"
          (click)="cancelRequest()"
        >
          <mat-icon class="hidden-md-up">clear</mat-icon>
          <span class="hidden-sm-down">Cancel</span>
        </button>
        <button
          type="button"
          *ngIf="request.id && canSubmitRequest"
          class="btn
          btn-outline-danger ripple"
          matTooltip="Delete Request"
          (click)="deleteRequest()"
        >
          <mat-icon class="hidden-md-up">clear</mat-icon>
          <span class="hidden-sm-down">Delete</span>
        </button>
        <button
          type="button"
          *ngIf="canManageRequest || canManageProject"
          [disabled]="
            !canManageRequest || request.status.toLowerCase() === 'complete'
          "
          (click)="approveRequest()"
          class="btn btn-primary"
          color="primary"
        >
          Approve Request
        </button>
        <!--
          <div class="spacer"></div>
          <button *ngIf="!printingInvoice" class="btn btn-link" (click)="captureScreen()">Print to PDF</button>
        -->
      </div>
    </div>
  </div>
  <div
    *ngIf="request"
    class="px-1 pt-1 full-width
    line-items"
  >
    <div *ngFor="let listType of request.itemsByType">
      <app-line-items
        (allApprove)="approveAll($event)"
        [itemList]="listType"
        (itemRemoved)="removeLineItem($event)"
        [printingInvoice]="printingInvoice"
        [draftMode]="editMode"
        [requestStartDate]="request.startDate"
        (itemsChanged)="itemsChanged($event)"
        [requestId]="request.id"
        [project]="project"
      ></app-line-items>
    </div>
  </div>

  <div
    *ngIf="request && project"
    class="hidden-sm-down d-flex mt-1 mb-4
    flex-row justify-content-around
    full-width"
  >
    <div *ngIf="request && request.id">
      <div class="row no-margin-left align-items-center">
        <h4 class="no-top-margin pr-1">Recapitulation</h4>
        <button
          type="button"
          *ngIf="
            request.status.toLowerCase() === 'pending' &&
            (canManageRequest || canManageProject)
          "
          (click)="approveRequest()"
          class="btn btn-primary"
          color="primary"
        >
          Approve Request
        </button>
        <button
          *ngIf="canSubmitRequest"
          [disabled]="
            signatureFormGroup.invalid ||
            notesFormGroup.hasError('notValid') ||
            !project ||
            !request.hasLineItems() ||
            !request.isDraft()
          "
          class="ripple
                btn
                btn-success mr-1"
          (click)="submitRequest()"
        >
          Submit Request
        </button>
      </div>
      <div class="full-width">
        <table id="invoice-table" class="table table-compact">
          <tbody>
            <tr *ngIf="project.laborCostsEnabled">
              <td class="left strong" colspan="3">Labor</td>
            </tr>
            <tr *ngIf="project.laborCostsEnabled">
              <td class="left">Labor</td>
              <td class="left">{{ request.laborSubtotal | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.laborCostsEnabled">
              <td class="left">Fringe Benefits</td>
              <td class="left">{{ request.laborBenefitsTotal | currency }}</td>
              <td></td>
            </tr>

            <tr *ngIf="project.laborCostsEnabled">
              <td class="left">Labor Markup (10%)</td>
              <td class="left">{{ request.laborMarkup | currency }}</td>
              <td></td>
            </tr>

            <tr *ngIf="project.laborCostsEnabled">
              <td class="left">Labor Total</td>
              <td class="left">{{ request.laborTotal | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.laborCostsEnabled">
              <td colspan="4"><br /></td>
            </tr>
            <tr *ngIf="project.equipmentCostsEnabled">
              <td class="left strong" colspan="3">Equipment</td>
            </tr>
            <tr *ngIf="project.equipmentCostsEnabled">
              <td class="left">Active Subtotal</td>
              <td class="left">{{ request.activeSubtotal | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.equipmentCostsEnabled">
              <td class="left">
                Active Markup ({{
                  project.adjustments.equipment.active.markup
                }}%)
              </td>
              <td class="left">{{ request.activeMarkup | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.equipmentCostsEnabled">
              <td class="left">Standby Subtotal</td>
              <td class="left">{{ request.standbySubtotal | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.equipmentCostsEnabled">
              <td class="left">
                Standby Markup ({{
                  project.adjustments.equipment.standby.markup
                }}%)
              </td>
              <td class="left">{{ request.standbyMarkup | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.equipmentCostsEnabled">
              <td class="left">Rental Subtotal</td>
              <td class="left">{{ request.rentalSubtotal | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.equipmentCostsEnabled">
              <td class="left">
                Rental Markup ({{
                  project.adjustments.equipment.rental.markup
                }}%)
              </td>
              <td class="left">{{ request.rentalMarkup | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.equipmentCostsEnabled">
              <td class="left">Equipment Total</td>
              <td class="left">{{ request.equipmentTotal | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.equipmentCostsEnabled">
              <td colspan="4"><br /></td>
            </tr>

            <tr *ngIf="project.materialCostsEnabled">
              <td class="left strong" colspan="3">Materials</td>
            </tr>
            <tr *ngIf="project.materialCostsEnabled">
              <td class="left">Materials Subtotal</td>
              <td class="left">{{ request.materialSubtotal | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.materialCostsEnabled">
              <td class="left">
                Materials Markup ({{ project.adjustments.material.markup }}%)
              </td>
              <td class="left">{{ request.materialMarkup | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.materialCostsEnabled">
              <td class="left">Materials Total</td>
              <td class="left">{{ request.materialTotal | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.materialCostsEnabled">
              <td colspan="4"><br /></td>
            </tr>
            <tr *ngIf="project.subcontractorCostsEnabled">
              <td class="left strong" colspan="3">Subcontractor</td>
            </tr>
            <tr *ngIf="project.subcontractorCostsEnabled">
              <td class="left">Subcontractor Subtotal</td>
              <td class="left">
                {{ request.subcontractorSubtotal | currency }}
              </td>
              <td></td>
            </tr>
            <tr *ngIf="project.subcontractorCostsEnabled">
              <td class="left">
                Subcontractor Markup ({{
                  project.adjustments.subcontractor.markup
                }}%)
              </td>
              <td class="left">{{ request.subcontractorMarkup | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.subcontractorCostsEnabled">
              <td class="left">Subcontractor Total</td>
              <td class="left">{{ request.subcontractorTotal | currency }}</td>
              <td></td>
            </tr>
            <tr *ngIf="project.subcontractorCostsEnabled">
              <td colspan="4"><br /></td>
            </tr>
            <tr *ngIf="project.otherCostsEnabled">
              <td class="left">Other Total</td>
              <td class="left">{{ request.otherTotal | currency }}</td>
              <td></td>
            </tr>

            <tr>
              <td colspan="4"><br /></td>
            </tr>
            <tr>
              <td class="left strong">TOTAL</td>
              <td class="left strong">{{ request.total | currency }}</td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div *ngIf="request && project" class="hidden-md-up mb-1">
    <div *ngIf="request">
      <h4>Recapitulation</h4>
      <div class="full-width">
        <table id="invoice-table" class="table table-compact">
          <thead>
            <tr>
              <th></th>
              <th>Subtotal</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="left">Equipment</td>
              <td class="left">{{ request.equipmentTotal | currency }}</td>
              <td></td>
            </tr>
            <tr>
              <td class="left">Material</td>
              <td class="left">{{ request.materialTotal | currency }}</td>
              <td></td>
            </tr>
            <tr>
              <td class="left">Other</td>
              <td class="left">{{ request.otherTotal | currency }}</td>
              <td></td>
            </tr>
            <tr>
              <td class="left">Subcontractor</td>
              <td class="left">{{ request.subcontractorTotal | currency }}</td>
              <td></td>
            </tr>
            <tr>
              <td class="left"></td>
              <td class="left"></td>
              <td class="left">{{ request.total | currency }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
